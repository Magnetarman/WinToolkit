# GitHub Actions Workflow per Continuous Integration con Test PowerShell
# Questo workflow si attiva solo quando vengono modificati file .ps1 nella cartella /tool
# Compila automaticamente WinToolkit.ps1 e testa il risultato prima di committare

name: CI_UpdateWinToolkit_Dev

# Configurazione del trigger: si attiva solo su modifiche a file .ps1 nella cartella /tool
on:
  push:
    branches: [Dev]
    paths:
      - "tool/*.ps1"
      - "WinToolkit-template.ps1"
      - "compiler.ps1"

# Definizione dei job del workflow
jobs:
  # Job principale che gestisce compilazione, test e commit automatico
  compile_test_and_commit:
    # Esecuzione su macchina virtuale Windows (ultima versione stabile)
    runs-on: windows-latest

    # Configurazione dei permessi necessari per il workflow
    permissions:
      contents: write
      actions: read

    # Definizione dei passi sequenziali del job
    steps:
      # Step 1: Checkout del codice sorgente con fetch completo per analizzare i commit
      - name: Checkout del repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      # Step 2: Verifica se ci sono modifiche rilevanti ai file PowerShell
      - name: Verifica modifiche rilevanti
        id: check_changes
        shell: pwsh
        run: |
          Write-Host "ğŸ” VERIFICA MODIFICHE RILEVANTI" -ForegroundColor Cyan
          Write-Host "=" * 60 -ForegroundColor Yellow

          # Lista dei file che dovrebbero triggerare il workflow
          $relevantPaths = @(
            "tool/*.ps1",
            "WinToolkit-template.ps1",
            "compiler.ps1"
          )

          # Ottieni i file modificati nell'ultimo commit
          $changedFiles = git diff --name-only HEAD~1 HEAD

          if ($changedFiles.Count -eq 0) {
            Write-Host "â„¹ï¸ Nessun file modificato nel commit corrente" -ForegroundColor Yellow
            Write-Host "âœ… Workflow completato senza azioni necessarie" -ForegroundColor Green
            exit 0
          }

          Write-Host "ğŸ“‹ File modificati nell'ultimo commit:" -ForegroundColor Green
          $changedFiles | ForEach-Object { Write-Host "  - $_" -ForegroundColor Gray }

          # Verifica se almeno uno dei file modificati Ã¨ rilevante
          $hasRelevantChanges = $false
          foreach ($file in $changedFiles) {
            foreach ($pattern in $relevantPaths) {
              if ($file -like $pattern) {
                $hasRelevantChanges = $true
                break
              }
            }
            if ($hasRelevantChanges) { break }
          }

          if (-not $hasRelevantChanges) {
            Write-Host "â„¹ï¸ Nessuna modifica rilevante per questo workflow" -ForegroundColor Yellow
            Write-Host "âœ… Workflow completato senza azioni necessarie" -ForegroundColor Green
            exit 0
          }

          Write-Host "âœ… Modifiche rilevanti rilevate - procedo con compilazione e test" -ForegroundColor Green
          Write-Output "has_relevant_changes=true" >> $env:GITHUB_OUTPUT

      # Step 3: Configurazione ambiente PowerShell
      - name: Setup PowerShell
        shell: pwsh
        run: |
          Write-Host "ğŸ”§ CONFIGURAZIONE AMBIENTE POWERSHELL" -ForegroundColor Cyan
          $PSVersionTable
          Write-Host "âœ… PowerShell configurato" -ForegroundColor Green

      # Step 4: Compilazione WinToolkit.ps1 tramite compiler.ps1
      - name: Compilazione WinToolkit.ps1
        if: steps.check_changes.outputs.has_relevant_changes == 'true'
        shell: pwsh
        run: |
          Write-Host "ğŸ”¨ COMPILAZIONE WINToolKIT.PS1" -ForegroundColor Cyan
          Write-Host "=" * 60 -ForegroundColor Yellow

          # Verifica che compiler.ps1 esista
          if (-not (Test-Path "compiler.ps1")) {
            Write-Error "âŒ File compiler.ps1 non trovato"
            exit 1
          }

          # Verifica che WinToolkit-template.ps1 esista
          if (-not (Test-Path "WinToolkit-template.ps1")) {
            Write-Error "âŒ File WinToolkit-template.ps1 non trovato"
            exit 1
          }

          # Verifica che ci siano file .ps1 nella cartella tool
          $toolFiles = Get-ChildItem -Path "tool" -Name "*.ps1" -ErrorAction SilentlyContinue
          if ($toolFiles.Count -eq 0) {
            Write-Error "âŒ Nessun file .ps1 trovato nella cartella tool"
            exit 1
          }

          Write-Host "ğŸ“‹ File da compilare: $($toolFiles.Count)" -ForegroundColor Green
          $toolFiles | ForEach-Object { Write-Host "  - $_" -ForegroundColor Gray }

          # Esegui la compilazione
          try {
            & ".\compiler.ps1"
            if ($LASTEXITCODE -ne 0) {
              Write-Error "âŒ Compilazione fallita con exit code: $LASTEXITCODE"
              exit 1
            }
          }
          catch {
            Write-Error "âŒ Errore durante la compilazione: $($_.Exception.Message)"
            exit 1
          }

          # Verifica che il file compilato sia stato creato
          if (-not (Test-Path "WinToolkit.ps1")) {
            Write-Error "âŒ File WinToolkit.ps1 non creato dalla compilazione"
            exit 1
          }

          $fileSize = (Get-Item "WinToolkit.ps1").Length
          Write-Host "âœ… Compilazione completata: $([math]::Round($fileSize/1KB, 2)) KB" -ForegroundColor Green

      # Step 5: Test estesi del file compilato
      - name: Test Estesi WinToolkit Compilato
        if: steps.check_changes.outputs.has_relevant_changes == 'true'
        shell: pwsh
        run: |
          Write-Host "ğŸ” TEST ESTESI DEL FILE COMPILATO" -ForegroundColor Cyan
          Write-Host "=" * 70 -ForegroundColor Yellow

          $winToolkitPath = "WinToolkit.ps1"

          # Verifica che il file esista
          if (-not (Test-Path $winToolkitPath)) {
            Write-Error "âŒ File WinToolkit.ps1 non trovato"
            exit 1
          }

          Write-Host "ğŸ“‹ Test del file finale: WinToolkit.ps1" -ForegroundColor Green

          $totalErrors = 0
          $testResults = @()

          try {
            $scriptContent = Get-Content -Raw -Path $winToolkitPath -ErrorAction Stop

            # Test 1: Sintassi PowerShell
            Write-Host "ğŸ” Test 1: Verifica sintassi..." -ForegroundColor Blue
            $parseErrors = $null
            $null = [System.Management.Automation.Language.Parser]::ParseInput($scriptContent, [ref]$null, [ref]$parseErrors)

            if ($parseErrors.Count -gt 0) {
              Write-Host "  âŒ Errori di sintassi:" -ForegroundColor Red
              foreach ($error in $parseErrors) {
                Write-Host "    Line $($error.Extent.StartLineNumber): $($error.Message)" -ForegroundColor Red
              }
              $totalErrors += $parseErrors.Count
              $testResults += "âŒ Sintassi: $($parseErrors.Count) errori"
            }
            else {
              Write-Host "  âœ… Sintassi OK" -ForegroundColor Green
              $testResults += "âœ… Sintassi: OK"
            }

            # Test 2: Verifica funzioni disponibili
            Write-Host "ğŸ” Test 2: Verifica funzioni disponibili..." -ForegroundColor Blue
            $functions = [System.Management.Automation.Language.Parser]::ParseInput($scriptContent, [ref]$null, [ref]$null) |
                        Where-Object { $_.GetType().Name -eq "FunctionDefinitionAst" }

            # Tutte le funzioni sono opzionali - verifica solo cosa Ã¨ presente
            $expectedFunctions = @("WinRepairToolkit", "WinCleaner", "OfficeToolkit", "SetRustDesk", "WinUpdateReset", "WinInstallPSProfile", "WinReinstallStore", "WinBackupDriver", "GamingToolkit", "WinDriverInstall", "SearchRepair")
            $presentFunctions = $expectedFunctions | Where-Object { $functionName = $_; $functions.Name -contains $functionName }
            $missingFunctions = $expectedFunctions | Where-Object { $functionName = $_; $functions.Name -notcontains $functionName }

            $presentCount = $presentFunctions.Count
            $missingCount = $missingFunctions.Count

            Write-Host "  ğŸ“Š Funzioni presenti: $presentCount" -ForegroundColor Green
            if ($presentFunctions.Count -gt 0) {
              $presentFunctions | ForEach-Object { Write-Host "    - $_" -ForegroundColor Green }
            }

            if ($missingCount -gt 0) {
              Write-Host "  âš ï¸ Funzioni mancanti (in sviluppo o non implementate):" -ForegroundColor Yellow
              $missingFunctions | ForEach-Object { Write-Host "    - $_" -ForegroundColor Yellow }
              $testResults += "âš ï¸ Funzioni mancanti: $($missingCount) (normale durante sviluppo)"
            }
            else {
              Write-Host "  âœ… Tutte le funzioni implementate presenti" -ForegroundColor Green
              $testResults += "âœ… Funzioni: Tutte presenti"
            }

            # Conta come avviso, non come errore
            $totalWarnings += $missingCount

            # Test 3: Struttura del menu
            Write-Host "ğŸ” Test 3: Verifica struttura menu..." -ForegroundColor Blue
            $menuTests = @(
              @{ Pattern = "while \(\$true\)"; Name = "Menu principale" },
              @{ Pattern = "Operazioni Preliminari"; Name = "Categoria Operazioni Preliminari" },
              @{ Pattern = "Windows & Office"; Name = "Categoria Windows & Office" },
              @{ Pattern = "Driver & Gaming"; Name = "Categoria Driver & Gaming" },
              @{ Pattern = "Supporto"; Name = "Categoria Supporto" }
            )

            foreach ($test in $menuTests) {
              if ($scriptContent -match $test.Pattern) {
                Write-Host "  âœ… $($test.Name)" -ForegroundColor Green
                $testResults += "âœ… $($test.Name)"
              }
              else {
                Write-Host "  âŒ $($test.Name) mancante" -ForegroundColor Red
                $totalErrors++
                $testResults += "âŒ $($test.Name) mancante"
              }
            }

            # Test 4: Dimensione del file
            Write-Host "ğŸ” Test 4: Verifica dimensione file..." -ForegroundColor Blue
            $fileSize = (Get-Item $winToolkitPath).Length
            $fileSizeKB = [math]::Round($fileSize/1KB, 2)

            if ($fileSize -lt 10000) {
              Write-Host "  âŒ File troppo piccolo: $($fileSize) bytes" -ForegroundColor Red
              $totalErrors++
              $testResults += "âŒ Dimensione: $fileSizeKB KB (troppo piccolo)"
            }
            else {
              Write-Host "  âœ… Dimensione OK: $fileSizeKB KB" -ForegroundColor Green
              $testResults += "âœ… Dimensione: $fileSizeKB KB"
            }

            # Test 5: Encoding UTF-8
            Write-Host "ğŸ” Test 5: Verifica encoding..." -ForegroundColor Blue
            $encoding = [System.Text.Encoding]::GetEncoding('UTF-8')
            $preamble = $encoding.GetPreamble()
            $fileBytes = Get-Content $winToolkitPath -AsByteStream -ReadCount 0

            if ($fileBytes.Length -ge 3 -and $fileBytes[0] -eq $preamble[0] -and $fileBytes[1] -eq $preamble[1] -and $fileBytes[2] -eq $preamble[2]) {
              Write-Host "  âœ… Encoding UTF-8 con BOM" -ForegroundColor Green
              $testResults += "âœ… Encoding: UTF-8 con BOM"
            }
            else {
              Write-Host "  âš ï¸ Encoding senza BOM (accettabile)" -ForegroundColor Yellow
              $testResults += "âš ï¸ Encoding: Senza BOM"
            }

          }
          catch {
            Write-Host "  âŒ Errore durante i test: $($_.Exception.Message)" -ForegroundColor Red
            $totalErrors++
            $testResults += "âŒ Errore test: $($_.Exception.Message)"
          }

          # Output risultati test
          Write-Host ""
          Write-Host "ğŸ“Š RIEPILOGO TEST:" -ForegroundColor Cyan
          $testResults | ForEach-Object { Write-Host "  $_" -ForegroundColor Gray }

          # Valuta i risultati: procedi sempre se non ci sono errori di sintassi/struttura
          if ($totalErrors -gt 0) {
            Write-Host "âŒ TEST FALLITI: $totalErrors errori di sintassi/struttura" -ForegroundColor Red
            Write-Host "ğŸ’¡ Suggerimento: Verifica la sintassi del file compilato" -ForegroundColor Cyan
            Write-Output "tests_passed=false" >> $env:GITHUB_OUTPUT
            exit 1
          }
          else {
            Write-Host "âœ… TUTTI I TEST SUPERATI!" -ForegroundColor Green
            if ($missingCount -gt 0) {
              Write-Host "â„¹ï¸ Nota: $missingCount funzioni mancanti - normale durante sviluppo" -ForegroundColor Yellow
            }
            Write-Output "tests_passed=true" >> $env:GITHUB_OUTPUT
          }

      # Step 6: Commit automatico del file compilato (solo se i test passano)
      - name: Commit WinToolkit.ps1
        if: steps.check_changes.outputs.has_relevant_changes == 'true' && steps.compile_test_and_commit.outputs.tests_passed == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: |
            ğŸ”§ Update WinToolkit.ps1 - Auto-compiled and tested

            â€¢ Compilazione automatica da file in /tool
            â€¢ Test di sintassi e struttura passati
            â€¢ Tutte le funzioni sono opzionali e in continuo sviluppo
            â€¢ File aggiornato e funzionale
          file_pattern: WinToolkit.ps1
          branch: Dev

      # Step 7: Output finale del workflow
      - name: Risultato Workflow
        shell: pwsh
        run: |
          Write-Host ""
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Green
          Write-Host "â•‘                 ğŸ‰ WORKFLOW COMPLETATO!                  â•‘" -ForegroundColor Green
          Write-Host "â•‘                                                          â•‘" -ForegroundColor White

          if ("${{ steps.check_changes.outputs.has_relevant_changes }}" -eq "true") {
            Write-Host "â•‘  âœ… Modifiche rilevanti rilevate                         â•‘" -ForegroundColor Green
            Write-Host "â•‘  ğŸ”¨ Compilazione eseguita                               â•‘" -ForegroundColor Green

            if ("${{ steps.compile_test_and_commit.outputs.tests_passed }}" -eq "true") {
              Write-Host "â•‘  âœ… Tutti i test superati                               â•‘" -ForegroundColor Green
              Write-Host "â•‘  ğŸ“ Commit automatico eseguito                          â•‘" -ForegroundColor Green
              Write-Host "â•‘                                                         â•‘" -ForegroundColor White
              Write-Host "â•‘  ğŸš€ WinToolkit.ps1 aggiornato e pronto!                 â•‘" -ForegroundColor Cyan
            }
            else {
              Write-Host "â•‘  âŒ Test falliti - commit non eseguito                  â•‘" -ForegroundColor Red
              Write-Host "â•‘                                                         â•‘" -ForegroundColor White
              Write-Host "â•‘  ğŸ’¡ Verifica i file in /tool e riprova                 â•‘" -ForegroundColor Cyan
            }
          }
          else {
            Write-Host "â•‘  â„¹ï¸ Nessuna modifica rilevante                          â•‘" -ForegroundColor Yellow
            Write-Host "â•‘  â­ï¸ Workflow completato senza azioni                   â•‘" -ForegroundColor Yellow
          }

          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Green
